<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Organizer Dashboard - Nearby Tournaments Finder</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    /* Base Styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }

    body {
      background-color: #f8fafc;
      color: #1f2937;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }

    .header-left h1 {
      color: #7c3aed;
      font-size: 1.8rem;
      margin-bottom: 5px;
    }

    .header-left .subtitle {
      color: #6b7280;
      font-size: 0.95rem;
    }

    .header-right {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      background: white;
      padding: 10px 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .logout-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background: #dc2626;
    }

    /* Dashboard Stats */
    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 20px;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-icon {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
    }

    .stat-icon.active {
      background: #dbeafe;
      color: #3b82f6;
    }

    .stat-icon.total {
      background: #f0f9ff;
      color: #0ea5e9;
    }

    .stat-icon.upcoming {
      background: #f0fdf4;
      color: #10b981;
    }

    .stat-content h3 {
      font-size: 2rem;
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 5px;
    }

    .stat-content p {
      color: #6b7280;
      font-size: 0.9rem;
    }

    /* Main Content Tabs */
    .dashboard-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 5px;
    }

    .tab-btn {
      background: none;
      border: none;
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 500;
      color: #6b7280;
      cursor: pointer;
      border-radius: 8px 8px 0 0;
      transition: all 0.3s;
      position: relative;
    }

    .tab-btn.active {
      color: #7c3aed;
    }

    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -7px;
      left: 0;
      right: 0;
      height: 3px;
      background: #7c3aed;
      border-radius: 3px;
    }

    .tab-btn:hover:not(.active) {
      background: #f3f4f6;
      color: #4b5563;
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Create Tournament Form */
    .form-container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      margin-bottom: 40px;
    }

    .form-container h2 {
      color: #1f2937;
      margin-bottom: 25px;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #374151;
      font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.3s;
      background: #f9fafb;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #8b5cf6;
      background: white;
      box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .required::after {
      content: " *";
      color: #ef4444;
    }

    .location-search-container {
      position: relative;
    }

    .location-search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: none;
    }

    .location-search-results.visible {
      display: block;
    }

    .location-result-item {
      padding: 12px;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      transition: background 0.2s;
    }

    .location-result-item:hover {
      background: #f9fafb;
    }

    .location-result-item:last-child {
      border-bottom: none;
    }

    .location-result-name {
      font-weight: 500;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .location-result-address {
      font-size: 0.85rem;
      color: #6b7280;
    }

    #address-preview {
      background: #f0f9ff;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border: 2px dashed #bae6fd;
      display: none;
    }

    #address-preview.visible {
      display: block;
    }

    .address-preview-text {
      color: #0369a1;
      font-weight: 500;
      margin-bottom: 5px;
    }

    .address-preview-coords {
      color: #0ea5e9;
      font-size: 0.85rem;
    }

    .form-actions {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #f3f4f6;
    }

    .primary-btn {
      background: #8b5cf6;
      color: white;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s;
      flex: 1;
    }

    .primary-btn:hover {
      background: #7c3aed;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .secondary-btn {
      background: #f3f4f6;
      color: #374151;
      border: none;
      padding: 14px 28px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.3s;
      flex: 1;
    }

    .secondary-btn:hover {
      background: #e5e7eb;
    }

    /* My Tournaments Section */
    .tournaments-list {
      display: grid;
      gap: 20px;
      margin-top: 20px;
    }

    .tournament-item {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      border-left: 4px solid #8b5cf6;
      transition: all 0.3s;
      position: relative;
    }

    .tournament-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    .tournament-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .tournament-title {
      font-size: 1.2rem;
      color: #1f2937;
      margin-bottom: 5px;
    }

    .tournament-sport {
      display: inline-block;
      background: #ede9fe;
      color: #7c3aed;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      margin-right: 10px;
    }

    .tournament-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .status-upcoming {
      background: #d1fae5;
      color: #059669;
    }

    .status-ongoing {
      background: #fef3c7;
      color: #d97706;
    }

    .status-completed {
      background: #f3f4f6;
      color: #6b7280;
    }

    .tournament-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
      padding: 15px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .detail-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .detail-icon {
      color: #8b5cf6;
      width: 20px;
      text-align: center;
    }

    .tournament-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .action-btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .edit-btn {
      background: #dbeafe;
      color: #3b82f6;
    }

    .edit-btn:hover {
      background: #bfdbfe;
    }

    .delete-btn {
      background: #fee2e2;
      color: #ef4444;
    }

    .delete-btn:hover {
      background: #fecaca;
    }

    .view-btn {
      background: #dcfce7;
      color: #16a34a;
    }

    .view-btn:hover {
      background: #bbf7d0;
    }

    /* Map Preview */
    #map-preview {
      height: 300px;
      margin-top: 20px;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      display: none;
    }

    #map-preview.visible {
      display: block;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .empty-icon {
      font-size: 4rem;
      color: #d1d5db;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      color: #4b5563;
      margin-bottom: 10px;
    }

    .empty-state p {
      color: #6b7280;
      max-width: 500px;
      margin: 0 auto 30px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }
      
      .dashboard-stats {
        grid-template-columns: 1fr;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      .tournament-header {
        flex-direction: column;
        gap: 10px;
      }
      
      .tournament-actions {
        flex-wrap: wrap;
      }
    }

    /* Success Message */
    .success-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  </style>
</head>
<body>

<div class="container">
  <!-- Header -->
  <header>
    <div class="header-left">
      <h1>üéØ Tournament Organizer Dashboard</h1>
      <p class="subtitle">Create, manage, and promote your sports tournaments</p>
    </div>
    <div class="header-right">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">O</div>
        <div>
          <div id="userName" style="font-weight: 500;">Organizer</div>
          <div style="font-size: 0.8rem; color: #6b7280;">Organizer Account</div>
        </div>
      </div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <!-- Dashboard Stats -->
  <section class="dashboard-stats">
    <div class="stat-card">
      <div class="stat-icon total">
        üèÜ
      </div>
      <div class="stat-content">
        <h3 id="totalTournaments">0</h3>
        <p>Total Tournaments</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon active">
        üìÖ
      </div>
      <div class="stat-content">
        <h3 id="activeTournaments">0</h3>
        <p>Active Tournaments</p>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon upcoming">
        üë•
      </div>
      <div class="stat-content">
        <h3 id="upcomingTournaments">0</h3>
        <p>Upcoming Tournaments</p>
      </div>
    </div>
  </section>

  <!-- Tabs -->
  <div class="dashboard-tabs">
    <button class="tab-btn active" onclick="showTab('create')">‚ûï Create Tournament</button>
    <button class="tab-btn" onclick="showTab('my-tournaments')">üìã My Tournaments</button>
    <button class="tab-btn" onclick="showTab('preview')">üëÅÔ∏è Preview on Map</button>
  </div>

  <!-- Tab 1: Create Tournament -->
  <div id="create-tab" class="tab-content active">
    <div class="form-container">
      <h2><span>‚ûï</span> Create New Tournament</h2>
      
      <form id="tournamentForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="tournament-name" class="required">Tournament Name</label>
            <input type="text" id="tournament-name" placeholder="e.g., Mumbai Cricket Premier League 2026" required>
          </div>
          
          <div class="form-group">
            <label for="tournament-sport" class="required">Sport</label>
            <select id="tournament-sport" required>
              <option value="">Select a sport</option>
              <option value="Football">Football</option>
              <option value="Badminton">Badminton</option>
              <option value="Cricket">Cricket</option>
              <option value="Running">Running</option>
              <option value="Table Tennis">Table Tennis</option>
              <option value="Basketball">Basketball</option>
              <option value="Hockey">Hockey</option>
              <option value="Tennis">Tennis</option>
              <option value="Athletics">Athletics</option>
              <option value="Archery">Archery</option>
              <option value="Kho-Kho">Kho-Kho</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="tournament-location" class="required">Tournament Location</label>
          <div class="location-search-container">
            <input type="text" id="tournament-location" 
                   placeholder="e.g., Wankhede Stadium, Mumbai or Full Address" 
                   required
                   oninput="searchLocations(this.value)">
            <div id="location-results" class="location-search-results"></div>
          </div>
          <small style="color: #6b7280; margin-top: 5px; display: block;">
            Start typing a venue name, stadium, park, or full address
          </small>
        </div>

        <div id="address-preview">
          <div class="address-preview-text" id="preview-address"></div>
          <div class="address-preview-coords" id="preview-coords"></div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="tournament-date" class="required">Start Date</label>
            <input type="date" id="tournament-date" required>
          </div>
          
          <div class="form-group">
            <label for="tournament-end-date">End Date (Optional)</label>
            <input type="date" id="tournament-end-date">
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="tournament-time" class="required">Start Time</label>
            <input type="time" id="tournament-time" required>
          </div>
          
          <div class="form-group">
            <label for="entry-fee">Entry Fee</label>
            <input type="text" id="entry-fee" placeholder="e.g., Free, ‚Çπ500, ‚Çπ1000 per team">
          </div>
        </div>

        <div class="form-group">
          <label for="prize-money">Prize Money (Optional)</label>
          <input type="text" id="prize-money" placeholder="e.g., ‚Çπ50,000 total prize pool">
        </div>

        <div class="form-group">
          <label for="description" class="required">Tournament Description</label>
          <textarea id="description" placeholder="Describe your tournament, rules, format, team size, etc." required></textarea>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="registration-link">Registration Link</label>
            <input type="url" id="registration-link" placeholder="https://example.com/register">
          </div>
          
          <div class="form-group">
            <label for="contact-email">Contact Email</label>
            <input type="email" id="contact-email" placeholder="contact@tournament.com">
          </div>
        </div>

        <div class="form-group">
          <label for="additional-info">Additional Information</label>
          <textarea id="additional-info" placeholder="Any other details participants should know..."></textarea>
        </div>

        <div class="form-actions">
          <button type="submit" class="primary-btn">Create Tournament</button>
          <button type="button" class="secondary-btn" onclick="clearForm()">Clear Form</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Tab 2: My Tournaments -->
  <div id="my-tournaments-tab" class="tab-content">
    <div class="form-container">
      <h2><span>üìã</span> My Tournaments</h2>
      
      <div id="my-tournaments-list" class="tournaments-list">
        <!-- Tournaments will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Tab 3: Preview on Map -->
  <div id="preview-tab" class="tab-content">
    <div class="form-container">
      <h2><span>üëÅÔ∏è</span> Preview Tournaments on Map</h2>
      <p style="color: #6b7280; margin-bottom: 20px;">
        See where your tournaments are located. These same locations will be visible to participants searching for events.
      </p>
      
      <div id="map-preview"></div>
    </div>
  </div>
</div>

<!-- Success Message Container -->
<div id="successMessage" class="success-message" style="display: none;">
  <span>‚úÖ</span>
  <span id="successText">Tournament created successfully!</span>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Check if user is organizer
const currentUser = JSON.parse(localStorage.getItem('currentUser'));
if (!currentUser || currentUser.userType !== 'organizer') {
  alert("Access denied! Organizer account required.");
  window.location.href = "index.html";
}

// Initialize user info
document.getElementById('userName').textContent = currentUser.fullName || 'Organizer';
document.getElementById('userAvatar').textContent = (currentUser.fullName || 'O').charAt(0).toUpperCase();

// Global variables
let organizerTournaments = [];
let selectedLocation = null;
let mapPreview = null;
let tournamentMarkers = [];

// Load organizer's tournaments
function loadOrganizerTournaments() {
  const allTournaments = JSON.parse(localStorage.getItem('organizerTournaments') || '[]');
  const userId = currentUser.id || currentUser.email;
  
  // Filter tournaments for current organizer
  organizerTournaments = allTournaments.filter(t => t.organizerId === userId);
  
  updateStats();
  displayMyTournaments();
  initMapPreview();
}

// Update dashboard stats
function updateStats() {
  const now = new Date();
  
  document.getElementById('totalTournaments').textContent = organizerTournaments.length;
  
  const activeTournaments = organizerTournaments.filter(t => {
    const startDate = new Date(t.startDate);
    const endDate = t.endDate ? new Date(t.endDate) : startDate;
    return startDate <= now && endDate >= now;
  });
  
  const upcomingTournaments = organizerTournaments.filter(t => {
    const startDate = new Date(t.startDate);
    return startDate > now;
  });
  
  document.getElementById('activeTournaments').textContent = activeTournaments.length;
  document.getElementById('upcomingTournaments').textContent = upcomingTournaments.length;
}

// Tab switching
function showTab(tabName) {
  // Update tab buttons
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  
  // Show selected tab
  event.target.classList.add('active');
  document.getElementById(`${tabName}-tab`).classList.add('active');
  
  // If preview tab, refresh map
  if (tabName === 'preview') {
    setTimeout(() => {
      if (mapPreview) {
        mapPreview.invalidateSize();
      }
    }, 100);
  }
}

// Location search functionality
let searchTimeout = null;

async function searchLocations(query) {
  if (searchTimeout) clearTimeout(searchTimeout);
  
  if (!query || query.length < 3) {
    hideLocationResults();
    return;
  }
  
  searchTimeout = setTimeout(async () => {
    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&countrycodes=in`,
        {
          headers: {
            'User-Agent': 'TournamentFinderApp/1.0'
          }
        }
      );
      
      if (!response.ok) throw new Error('Search failed');
      
      const results = await response.json();
      displayLocationResults(results);
    } catch (error) {
      console.error('Search error:', error);
      fallbackLocationSearch(query);
    }
  }, 300);
}

function fallbackLocationSearch(query) {
  const commonLocations = {
    'wankhede stadium': { lat: 18.9389, lon: 72.8258, display: 'Wankhede Stadium, Mumbai' },
    'eden gardens': { lat: 22.5646, lon: 88.3433, display: 'Eden Gardens, Kolkata' },
    'chinnaswamy stadium': { lat: 12.9788, lon: 77.5996, display: 'M. Chinnaswamy Stadium, Bangalore' },
    'chepauk stadium': { lat: 13.0622, lon: 80.2794, display: 'M. A. Chidambaram Stadium, Chennai' },
    'indra gandhi stadium': { lat: 28.7041, lon: 77.1025, display: 'Indira Gandhi Stadium, Delhi' },
    'major dhyan chand stadium': { lat: 28.6139, lon: 77.2370, display: 'Major Dhyan Chand Stadium, Delhi' },
    'marine drive': { lat: 19.0760, lon: 72.8777, display: 'Marine Drive, Mumbai' },
    'india gate': { lat: 28.6129, lon: 77.2295, display: 'India Gate, Delhi' },
    'jawaharlal nehru stadium': { lat: 28.5833, lon: 77.2333, display: 'Jawaharlal Nehru Stadium, Delhi' },
  };
  
  const queryLower = query.toLowerCase();
  const results = [];
  
  for (const [key, value] of Object.entries(commonLocations)) {
    if (queryLower.includes(key)) {
      results.push({
        display_name: value.display,
        lat: value.lat,
        lon: value.lon
      });
    }
  }
  
  if (results.length === 0) {
    results.push({
      display_name: `${query} (approximate location)`,
      lat: 20.5937,
      lon: 78.9629,
      approximate: true
    });
  }
  
  displayLocationResults(results);
}

function displayLocationResults(results) {
  const container = document.getElementById('location-results');
  
  if (!results || results.length === 0) {
    container.innerHTML = '<div class="location-result-item">No locations found</div>';
    container.classList.add('visible');
    return;
  }
  
  let html = '';
  results.forEach(result => {
    const isApprox = result.approximate || false;
    html += `
      <div class="location-result-item" onclick="selectLocation(${result.lat}, ${result.lon}, '${result.display_name.replace(/'/g, "\\'")}', ${isApprox})">
        <div class="location-result-name">${result.display_name}</div>
        ${isApprox ? '<div class="location-result-address">Approximate location</div>' : ''}
      </div>
    `;
  });
  
  container.innerHTML = html;
  container.classList.add('visible');
}

function hideLocationResults() {
  document.getElementById('location-results').classList.remove('visible');
}

function selectLocation(lat, lon, displayName, isApproximate = false) {
  selectedLocation = { lat, lon, displayName, isApproximate };
  
  // Update UI
  document.getElementById('tournament-location').value = displayName;
  
  const preview = document.getElementById('address-preview');
  preview.querySelector('#preview-address').textContent = displayName;
  preview.querySelector('#preview-coords').textContent = 
    `Coordinates: ${lat.toFixed(4)}, ${lon.toFixed(4)} ${isApproximate ? '(Approximate)' : ''}`;
  
  preview.classList.add('visible');
  hideLocationResults();
}

// Tournament form submission
document.getElementById('tournamentForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  if (!selectedLocation) {
    alert('Please select a valid location for your tournament');
    return;
  }
  
  const tournamentData = {
    id: Date.now().toString(),
    organizerId: currentUser.id || currentUser.email,
    organizerName: currentUser.fullName || 'Organizer',
    name: document.getElementById('tournament-name').value,
    sport: document.getElementById('tournament-sport').value,
    location: selectedLocation.displayName,
    lat: selectedLocation.lat,
    lon: selectedLocation.lon,
    startDate: document.getElementById('tournament-date').value,
    endDate: document.getElementById('tournament-end-date').value || null,
    time: document.getElementById('tournament-time').value,
    entryFee: document.getElementById('entry-fee').value || 'Free',
    prizeMoney: document.getElementById('prize-money').value || '',
    description: document.getElementById('description').value,
    registrationLink: document.getElementById('registration-link').value || '',
    contactEmail: document.getElementById('contact-email').value || '',
    additionalInfo: document.getElementById('additional-info').value || '',
    createdAt: new Date().toISOString(),
    status: 'upcoming'
  };
  
  // Save tournament
  const allTournaments = JSON.parse(localStorage.getItem('organizerTournaments') || '[]');
  allTournaments.push(tournamentData);
  localStorage.setItem('organizerTournaments', JSON.stringify(allTournaments));
  
  // Show success message
  showSuccessMessage('Tournament created successfully! It will be visible to participants.');
  
  // Refresh lists
  loadOrganizerTournaments();
  
  // Clear form
  clearForm();
  
  // Switch to My Tournaments tab
  showTab('my-tournaments');
});

function showSuccessMessage(message) {
  document.getElementById('successText').textContent = message;
  const msg = document.getElementById('successMessage');
  msg.style.display = 'flex';
  msg.style.animation = 'none';
  setTimeout(() => {
    msg.style.animation = 'slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards';
  }, 10);
}

function clearForm() {
  document.getElementById('tournamentForm').reset();
  document.getElementById('address-preview').classList.remove('visible');
  selectedLocation = null;
}

// Display organizer's tournaments
function displayMyTournaments() {
  const container = document.getElementById('my-tournaments-list');
  
  if (organizerTournaments.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üèÜ</div>
        <h3>No Tournaments Yet</h3>
        <p>You haven't created any tournaments. Create your first tournament to start attracting participants!</p>
        <button class="primary-btn" onclick="showTab('create')">Create Your First Tournament</button>
      </div>
    `;
    return;
  }
  
  // Sort by date (newest first)
  const sortedTournaments = [...organizerTournaments].sort((a, b) => 
    new Date(b.createdAt) - new Date(a.createdAt)
  );
  
  let html = '';
  sortedTournaments.forEach(tournament => {
    const startDate = new Date(tournament.startDate);
    const now = new Date();
    let status = 'upcoming';
    let statusText = 'Upcoming';
    
    if (tournament.endDate) {
      const endDate = new Date(tournament.endDate);
      if (startDate <= now && endDate >= now) {
        status = 'ongoing';
        statusText = 'Ongoing';
      } else if (endDate < now) {
        status = 'completed';
        statusText = 'Completed';
      }
    } else if (startDate < now) {
      status = 'completed';
      statusText = 'Completed';
    }
    
    const dateDisplay = tournament.endDate 
      ? `${formatDate(startDate)} - ${formatDate(new Date(tournament.endDate))}`
      : formatDate(startDate);
    
    html += `
      <div class="tournament-item">
        <div class="tournament-header">
          <div>
            <h3 class="tournament-title">${tournament.name}</h3>
            <span class="tournament-sport">${tournament.sport}</span>
            <span class="tournament-status status-${status}">${statusText}</span>
          </div>
          <div style="font-size: 0.9rem; color: #6b7280;">
            Created: ${formatDate(new Date(tournament.createdAt))}
          </div>
        </div>
        
        <div class="tournament-details">
          <div class="detail-item">
            <span class="detail-icon">üìç</span>
            <span>${tournament.location}</span>
          </div>
          <div class="detail-item">
            <span class="detail-icon">üìÖ</span>
            <span>${dateDisplay} at ${tournament.time}</span>
          </div>
          <div class="detail-item">
            <span class="detail-icon">üí∞</span>
            <span>${tournament.entryFee}</span>
          </div>
          ${tournament.prizeMoney ? `
            <div class="detail-item">
              <span class="detail-icon">üèÜ</span>
              <span>${tournament.prizeMoney}</span>
            </div>
          ` : ''}
        </div>
        
        <p style="color: #4b5563; margin-bottom: 10px;">${tournament.description.substring(0, 150)}...</p>
        
        <div class="tournament-actions">
          <button class="action-btn edit-btn" onclick="editTournament('${tournament.id}')">Edit</button>
          <button class="action-btn delete-btn" onclick="deleteTournament('${tournament.id}')">Delete</button>
          ${tournament.registrationLink ? `
            <a href="${tournament.registrationLink}" target="_blank" class="action-btn view-btn">Registration Link</a>
          ` : ''}
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function formatDate(date) {
  return date.toLocaleDateString('en-IN', {
    day: 'numeric',
    month: 'short',
    year: 'numeric'
  });
}

function editTournament(tournamentId) {
  const tournament = organizerTournaments.find(t => t.id === tournamentId);
  if (!tournament) return;
  
  // Fill form with tournament data
  document.getElementById('tournament-name').value = tournament.name;
  document.getElementById('tournament-sport').value = tournament.sport;
  document.getElementById('tournament-date').value = tournament.startDate;
  document.getElementById('tournament-end-date').value = tournament.endDate || '';
  document.getElementById('tournament-time').value = tournament.time;
  document.getElementById('entry-fee').value = tournament.entryFee;
  document.getElementById('prize-money').value = tournament.prizeMoney || '';
  document.getElementById('description').value = tournament.description;
  document.getElementById('registration-link').value = tournament.registrationLink || '';
  document.getElementById('contact-email').value = tournament.contactEmail || '';
  document.getElementById('additional-info').value = tournament.additionalInfo || '';
  
  // Set location
  selectedLocation = {
    lat: tournament.lat,
    lon: tournament.lon,
    displayName: tournament.location,
    isApproximate: false
  };
  
  const preview = document.getElementById('address-preview');
  preview.querySelector('#preview-address').textContent = tournament.location;
  preview.querySelector('#preview-coords').textContent = 
    `Coordinates: ${tournament.lat.toFixed(4)}, ${tournament.lon.toFixed(4)}`;
  preview.classList.add('visible');
  
  // Switch to create tab
  showTab('create');
  
  // Change form to update mode
  const form = document.getElementById('tournamentForm');
  const submitBtn = form.querySelector('button[type="submit"]');
  submitBtn.textContent = 'Update Tournament';
  submitBtn.onclick = function(e) {
    e.preventDefault();
    updateTournament(tournamentId);
  };
}

function updateTournament(tournamentId) {
  if (!selectedLocation) {
    alert('Please select a valid location');
    return;
  }
  
  const updatedData = {
    name: document.getElementById('tournament-name').value,
    sport: document.getElementById('tournament-sport').value,
    location: selectedLocation.displayName,
    lat: selectedLocation.lat,
    lon: selectedLocation.lon,
    startDate: document.getElementById('tournament-date').value,
    endDate: document.getElementById('tournament-end-date').value || null,
    time: document.getElementById('tournament-time').value,
    entryFee: document.getElementById('entry-fee').value || 'Free',
    prizeMoney: document.getElementById('prize-money').value || '',
    description: document.getElementById('description').value,
    registrationLink: document.getElementById('registration-link').value || '',
    contactEmail: document.getElementById('contact-email').value || '',
    additionalInfo: document.getElementById('additional-info').value || '',
    updatedAt: new Date().toISOString()
  };
  
  // Update in localStorage
  const allTournaments = JSON.parse(localStorage.getItem('organizerTournaments') || '[]');
  const index = allTournaments.findIndex(t => t.id === tournamentId);
  
  if (index !== -1) {
    allTournaments[index] = { ...allTournaments[index], ...updatedData };
    localStorage.setItem('organizerTournaments', JSON.stringify(allTournaments));
  }
  
  showSuccessMessage('Tournament updated successfully!');
  loadOrganizerTournaments();
  clearForm();
  
  // Reset form to create mode
  const submitBtn = document.querySelector('#tournamentForm button[type="submit"]');
  submitBtn.textContent = 'Create Tournament';
  submitBtn.onclick = null;
}

function deleteTournament(tournamentId) {
  if (!confirm('Are you sure you want to delete this tournament? This action cannot be undone.')) {
    return;
  }
  
  const allTournaments = JSON.parse(localStorage.getItem('organizerTournaments') || '[]');
  const filtered = allTournaments.filter(t => t.id !== tournamentId);
  localStorage.setItem('organizerTournaments', JSON.stringify(filtered));
  
  showSuccessMessage('Tournament deleted successfully');
  loadOrganizerTournaments();
}

// Map preview initialization
function initMapPreview() {
  const mapContainer = document.getElementById('map-preview');
  
  if (organizerTournaments.length === 0) {
    mapContainer.classList.remove('visible');
    return;
  }
  
  mapContainer.classList.add('visible');
  
  if (!mapPreview) {
    // Initialize map centered on first tournament
    const firstTournament = organizerTournaments[0];
    mapPreview = L.map('map-preview').setView([firstTournament.lat, firstTournament.lon], 10);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(mapPreview);
  } else {
    // Clear existing markers
    tournamentMarkers.forEach(marker => mapPreview.removeLayer(marker));
    tournamentMarkers = [];
  }
  
  // Add markers for each tournament
  organizerTournaments.forEach(tournament => {
    const marker = L.marker([tournament.lat, tournament.lon], {
      icon: L.divIcon({
        className: 'tournament-marker',
        html: `<div style="background:#8b5cf6; color:white; width:32px; height:32px; border-radius:50%; border:3px solid white; display:flex; align-items:center; justify-content:center; font-weight:bold; box-shadow:0 2px 6px rgba(0,0,0,0.3);">${tournament.sport.charAt(0)}</div>`,
        iconSize: [38, 38],
        iconAnchor: [19, 19]
      })
    }).addTo(mapPreview)
      .bindPopup(`
        <strong>${tournament.name}</strong><br>
        <em>${tournament.sport}</em><br>
        üìç ${tournament.location}<br>
        üìÖ ${formatDate(new Date(tournament.startDate))}<br>
        üí∞ ${tournament.entryFee}
      `);
    
    tournamentMarkers.push(marker);
  });
  
  // Fit bounds to show all markers
  if (tournamentMarkers.length > 0) {
    const group = L.featureGroup(tournamentMarkers);
    mapPreview.fitBounds(group.getBounds().pad(0.1));
  }
}

function logout() {
  localStorage.removeItem('currentUser');
  window.location.href = "index.html";
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  loadOrganizerTournaments();
  
  // Set minimum date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('tournament-date').min = today;
  document.getElementById('tournament-end-date').min = today;
  
  // Set default time to 9:00 AM
  document.getElementById('tournament-time').value = '09:00';
});
</script>
</body>
</html>