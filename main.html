<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nearby Tournaments Finder</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    /* Base Styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
    }

    body {
      background-color: #f8fafc;
      color: #1f2937;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-left h1 {
      color: #1e40af;
      font-size: 1.8rem;
      margin-bottom: 5px;
    }

    .header-left .subtitle {
      color: #6b7280;
      font-size: 0.95rem;
    }

    .header-right {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      background: white;
      padding: 10px 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #3b82f6, #1e40af);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .user-type {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 2px;
    }

    .logout-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background: #dc2626;
    }

    .organizer-btn {
      background: #7c3aed;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.3s;
      text-decoration: none;
      display: inline-block;
    }

    .organizer-btn:hover {
      background: #6d28d9;
    }

    /* Status Box */
    #status {
      background: #f0f9ff;
      padding: 16px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 25px;
      border-left: 4px solid #3b82f6;
    }

    .error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
      border-left: 4px solid #ef4444;
    }

    /* Sports Filter */
    #sports-filters {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      margin-bottom: 25px;
    }

    #sports-filters h2 {
      color: #1f2937;
      margin-bottom: 20px;
      text-align: center;
    }

    .sports-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
    }

    .sports-grid label {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 15px;
      background: #f8fafc;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .sports-grid label:hover {
      background: #e2e8f0;
      transform: translateY(-2px);
    }

    .sports-grid input[type="checkbox"]:checked + span {
      font-weight: 600;
      color: #1e40af;
    }

    .sports-grid label:has(input:checked) {
      background: #dbeafe;
      border-color: #3b82f6;
    }

    .sports-grid input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .sport-text {
      font-size: 1rem;
      color: #4b5563;
    }

    /* Main Button */
    .main-btn {
      display: block;
      width: 100%;
      max-width: 400px;
      margin: 30px auto;
      padding: 16px 24px;
      background: linear-gradient(135deg, #3b82f6, #1e40af);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .main-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    /* Results */
    #results {
      margin-top: 40px;
    }

    .results-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .results-header h2 {
      color: #1f2937;
      font-size: 1.6rem;
      margin-bottom: 10px;
    }

    .results-count {
      color: #6b7280;
      font-size: 1rem;
    }

    /* Tournament Cards */
    .tournament-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      border: 1px solid #e5e7eb;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .tournament-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }

    .tournament-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 5px;
      height: 100%;
      background: linear-gradient(to bottom, #3b82f6, #1e40af);
    }

    .organizer-tournament::before {
      background: linear-gradient(to bottom, #7c3aed, #5b21b6);
    }

    .tournament-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .tournament-title {
      font-size: 1.3rem;
      color: #1e40af;
      margin-bottom: 8px;
      flex: 1;
    }

    .organizer-tournament .tournament-title {
      color: #7c3aed;
    }

    .tournament-meta {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }

    .distance {
      color: #059669;
      font-weight: 700;
      font-size: 1.1rem;
      background: #d1fae5;
      padding: 6px 14px;
      border-radius: 20px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .distance::before {
      content: 'üìç';
    }

    .sport-badge {
      background: #dbeafe;
      color: #1e40af;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .organizer-badge {
      background: #ede9fe;
      color: #7c3aed;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-left: 10px;
    }

    .organizer-badge::before {
      content: 'üéØ';
    }

    .tournament-details {
      margin: 20px 0;
    }

    .detail-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      color: #4b5563;
    }

    .detail-icon {
      color: #6b7280;
      width: 20px;
      text-align: center;
    }

    .location {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      color: #6b7280;
      margin: 10px 0;
    }

    .organizer-info {
      background: #f5f3ff;
      padding: 12px 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 3px solid #7c3aed;
    }

    .organizer-label {
      font-weight: 600;
      color: #7c3aed;
      margin-bottom: 5px;
    }

    .card-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }

    .register-btn {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .register-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .register-btn::before {
      content: 'üèÜ';
    }

    .route-btn {
      background: linear-gradient(135deg, #3b82f6, #1e40af);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .route-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .route-btn::before {
      content: 'üöó';
    }

    /* Map */
    #map {
      height: 500px;
      margin: 40px 0;
      border-radius: 15px;
      border: 2px solid #e5e7eb;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      z-index: 1;
    }

    /* Directions Panel */
    .directions-panel {
      position: fixed;
      right: 0;
      top: 0;
      width: 400px;
      height: 100%;
      background: white;
      box-shadow: -5px 0 20px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      padding: 0;
      overflow: hidden;
      transform: translateX(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .directions-panel.active {
      transform: translateX(0);
    }

    .panel-header {
      padding: 25px;
      background: linear-gradient(135deg, #3b82f6, #1e40af);
      color: white;
    }

    .panel-header h2 {
      margin: 0;
      color: white;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-close {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      position: absolute;
      top: 20px;
      right: 20px;
      transition: background 0.3s;
    }

    .panel-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .panel-content {
      padding: 25px;
      height: calc(100% - 90px);
      overflow-y: auto;
    }

    .route-summary {
      background: #f0f9ff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    .summary-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .instructions-list {
      margin-top: 20px;
    }

    .instruction-step {
      padding: 15px;
      margin-bottom: 12px;
      background: #f9fafb;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .step-number {
      background: #3b82f6;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .step-text {
      flex: 1;
      color: #4b5563;
    }

    .step-distance {
      color: #6b7280;
      font-size: 0.9rem;
      margin-top: 5px;
    }

    /* Organizer Section */
    .organizer-section {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      margin: 40px 0;
      border: 2px solid #e5e7eb;
    }

    .organizer-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
    }

    .organizer-header h2 {
      color: #7c3aed;
      margin: 0;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.05);
      margin: 40px 0;
    }

    .empty-icon {
      font-size: 4rem;
      color: #d1d5db;
      margin-bottom: 20px;
    }

    .empty-state h3 {
      color: #4b5563;
      margin-bottom: 10px;
    }

    .empty-state p {
      color: #6b7280;
      max-width: 500px;
      margin: 0 auto 30px;
      line-height: 1.6;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .directions-panel {
        width: 350px;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      header {
        flex-direction: column;
        text-align: center;
      }
      
      .header-right {
        width: 100%;
        justify-content: center;
      }
      
      .sports-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }
      
      #map {
        height: 400px;
      }
      
      .tournament-header {
        flex-direction: column;
      }
      
      .card-actions {
        flex-direction: column;
      }
      
      .register-btn, .route-btn {
        width: 100%;
        justify-content: center;
      }
      
      .directions-panel {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .sports-grid {
        grid-template-columns: 1fr;
      }
      
      .tournament-meta {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <!-- Header -->
  <header>
    <div class="header-left">
      <h1>üèÜ Nearby Tournaments Finder</h1>
      <p class="subtitle">Find and join sports tournaments near you</p>
    </div>
    <div class="header-right">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">P</div>
        <div>
          <div id="userName" style="font-weight: 500;">Participant</div>
          <div class="user-type">Participant Account</div>
        </div>
      </div>
      <button class="logout-btn" onclick="logout()">Logout</button>
      <a href="organizer-dashboard.html" class="organizer-btn" id="organizerLink">Switch to Organizer</a>
    </div>
  </header>

  <!-- Status -->
  <div id="status">Select sports you're interested in and click the button below to find tournaments near you...</div>

  <!-- Sports Filter -->
  <section id="sports-filters">
    <h2>Select Sports You're Interested In</h2>
    <div class="sports-grid">
      <label>
        <input type="checkbox" name="sport" value="Football">
        <span class="sport-text">‚öΩ Football</span>
      </label>
      <label>
        <input type="checkbox" name="sport" value="Badminton">
        <span class="sport-text">üè∏ Badminton</span>
      </label>
      <label>
        <input type="checkbox" name="sport" value="Cricket">
        <span class="sport-text">üèè Cricket</span>
      </label>
      <label>
        <input type="checkbox" name="sport" value="Running">
        <span class="sport-text">üèÉ Running</span>
      </label>
      <label>
        <input type="checkbox" name="sport" value="Table Tennis">
        <span class="sport-text">üèì Table Tennis</span>
      </label>
      <label>
        <input type="checkbox" name="sport" value="Basketball">
        <span class="sport-text">üèÄ Basketball</span>
      </label>
      <label>
        <input type="checkbox" name="sport" value="Hockey">
        <span class="sport-text">üèë Hockey</span>
      </label>
      <label>
        <input type="checkbox" name="sport" value="Tennis">
        <span class="sport-text">üéæ Tennis</span>
      </label>
      <label>
        <input type="checkbox" name="sport" value="Athletics">
        <span class="sport-text">üèÖ Athletics</span>
      </label>
      <label>
        <input type="checkbox" name="sport" value="Archery">
        <span class="sport-text">üèπ Archery</span>
      </label>
      <label>
        <input type="checkbox" name="sport" value="Kho-Kho">
        <span class="sport-text">üèÉ Kho-Kho</span>
      </label>
    </div>
  </section>

  <!-- Find Tournaments Button -->
  <button class="main-btn" onclick="findTournaments()">
    üîç Find Nearby Upcoming Tournaments
  </button>

  <!-- Results Section -->
  <div id="results">
    <!-- Results will be loaded here -->
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Directions Panel -->
  <div id="directionsPanel" class="directions-panel">
    <div class="panel-header">
      <h2>üöó Route Directions</h2>
      <button class="panel-close" onclick="hideDirections()">√ó</button>
    </div>
    <div class="panel-content">
      <div id="routeSummary" class="route-summary">
        <p>Select a tournament and click "Get Directions" to see the route.</p>
      </div>
      <div id="routeInstructions" class="instructions-list"></div>
    </div>
  </div>

  <!-- Organizer Promotion -->
  <div class="organizer-section" id="organizerSection">
    <div class="organizer-header">
      <h2 id="organizerTitle">üéØ Want to Organize Your Own Tournament?</h2>
    </div>
    <p id="organizerDescription" style="color: #4b5563; margin-bottom: 20px; line-height: 1.6;">
      Create and promote your sports tournaments to reach thousands of potential participants in your area.
      As an organizer, you can set up tournaments, manage registrations, and connect with players.
    </p>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
      <a href="organizer-dashboard.html" class="organizer-btn" style="padding: 14px 28px; font-size: 1.1rem;" id="organizerActionBtn">
        üéØ Switch to Organizer Dashboard
      </a>
      <button class="secondary-btn" style="background: #f3f4f6; color: #374151; border: none; padding: 14px 28px; border-radius: 8px; cursor: pointer; font-weight: 600;" onclick="showOrganizerBenefits()">
        ‚ÑπÔ∏è Learn More
      </button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script>
// Check authentication
const currentUser = JSON.parse(localStorage.getItem('currentUser'));
if (!currentUser) {
  alert("Please login first!");
  window.location.href = "index.html";
}

// Global variables
let map = null;
let routingControl = null;
let userMarker = null;
let tournamentMarkers = [];
let userLat = null;
let userLon = null;

// Initialize database
function initializeDatabase() {
  if (!localStorage.getItem('tournaments')) {
    const initialTournaments = [
      { 
        id: '1',
        name: "YONEX-SUNRISE ALL INDIA MASTERS RANKING BADMINTON", 
        sport: "Badminton", 
        location: "Indira Gandhi Stadium, New Delhi", 
        lat: 28.7041, 
        lon: 77.1025, 
        date: "Jan 25 - Feb 1, 2026", 
        fee: "‚Çπ1200",
        details: "All India ranking tournament for masters category",
        regLink: "https://example.com/register1",
        organizerName: "Sports Authority of India",
        organizerId: 'system',
        isOrganizer: false,
        createdAt: new Date().toISOString()
      },
      { 
        id: '2',
        name: "29th Akhil Bharatiya Meghbaran Singh Hockey Tournament", 
        sport: "Hockey", 
        location: "Major Dhyan Chand Stadium, Varanasi", 
        lat: 25.5833, 
        lon: 83.5853, 
        date: "Feb 4-14, 2026", 
        fee: "‚Çπ800 per team",
        details: "29th edition of the national hockey tournament",
        regLink: "https://example.com/register2",
        organizerName: "Hockey India",
        organizerId: 'system',
        isOrganizer: false,
        createdAt: new Date().toISOString()
      },
      { 
        id: '3',
        name: "Mumbai Marathon 2026", 
        sport: "Running", 
        location: "Marine Drive, Mumbai", 
        lat: 19.0760, 
        lon: 72.8777, 
        date: "Feb 15, 2026", 
        fee: "Free",
        details: "Annual marathon with 5K, 10K, and 21K categories",
        regLink: "https://example.com/register3",
        organizerName: "Mumbai Marathon Association",
        organizerId: 'system',
        isOrganizer: false,
        createdAt: new Date().toISOString()
      },
      { 
        id: '4',
        name: "Delhi Cricket Premier League", 
        sport: "Cricket", 
        location: "Feroz Shah Kotla Ground, Delhi", 
        lat: 28.6381, 
        lon: 77.2433, 
        date: "Mar 1-10, 2026", 
        fee: "‚Çπ2500 per team",
        details: "Corporate cricket league",
        regLink: "",
        organizerName: "Delhi Cricket Association",
        organizerId: 'system',
        isOrganizer: false,
        createdAt: new Date().toISOString()
      },
      { 
        id: '5',
        name: "Bangalore Basketball Tournament", 
        sport: "Basketball", 
        location: "Kanteerava Indoor Stadium, Bangalore", 
        lat: 12.9788, 
        lon: 77.5996, 
        date: "Feb 20-25, 2026", 
        fee: "‚Çπ1000 per team",
        details: "Inter-college basketball championship",
        regLink: "https://example.com/register5",
        organizerName: "Karnataka Basketball Association",
        organizerId: 'system',
        isOrganizer: false,
        createdAt: new Date().toISOString()
      }
    ];
    localStorage.setItem('tournaments', JSON.stringify(initialTournaments));
  }
}

// Set user info and update UI based on user type
function setupUserInterface() {
  const userName = currentUser.fullName || 'Participant';
  const userType = currentUser.userType || 'participant';
  const isOrganizer = userType === 'organizer';
  
  // Update user info
  document.getElementById('userName').textContent = userName;
  document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();
  document.querySelector('.user-type').textContent = isOrganizer ? 'Organizer Account' : 'Participant Account';
  
  // Update organizer button
  const organizerLink = document.getElementById('organizerLink');
  organizerLink.textContent = isOrganizer ? 'Switch to Organizer Dashboard' : 'Become an Organizer';
  
  // Update organizer section
  const organizerTitle = document.getElementById('organizerTitle');
  const organizerDescription = document.getElementById('organizerDescription');
  const organizerActionBtn = document.getElementById('organizerActionBtn');
  
  if (isOrganizer) {
    organizerTitle.textContent = 'üéØ Manage Your Tournaments';
    organizerDescription.textContent = 'Manage and promote your sports tournaments. Create new events, edit existing ones, and reach thousands of participants.';
    organizerActionBtn.textContent = 'üéØ Go to Dashboard';
  } else {
    organizerTitle.textContent = 'üéØ Want to Organize Your Own Tournament?';
    organizerDescription.textContent = 'Create and promote your sports tournaments to reach thousands of potential participants in your area. As an organizer, you can set up tournaments, manage registrations, and connect with players.';
    organizerActionBtn.textContent = 'üéØ Become an Organizer';
  }
}

// Load all tournaments from unified database
function loadAllTournaments() {
  initializeDatabase();
  return JSON.parse(localStorage.getItem('tournaments') || '[]');
}

// Calculate distance
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return Math.round(R * c * 10) / 10;
}

// Initialize map
function initMap(lat, lon) {
  if (map) {
    map.remove();
  }
  
  map = L.map('map').setView([lat, lon], 10);
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);
  
  // User location marker
  if (userMarker) {
    map.removeLayer(userMarker);
  }
  
  userMarker = L.marker([lat, lon], {
    icon: L.divIcon({
      className: 'user-location-icon',
      html: '<div style="background:#3b82f6; width:28px; height:28px; border-radius:50%; border:4px solid white; box-shadow:0 2px 8px rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:14px;">YOU</div>',
      iconSize: [36, 36],
      iconAnchor: [18, 18]
    })
  }).addTo(map).bindPopup('Your Current Location').openPopup();
}

// Main function to find tournaments
function findTournaments() {
  const status = document.getElementById('status');
  status.textContent = "Getting your location...";
  status.className = "";
  
  if (!navigator.geolocation) {
    status.textContent = "Geolocation not supported by your browser.";
    status.className = "error";
    return;
  }
  
  navigator.geolocation.getCurrentPosition(
    async (position) => {
      try {
        userLat = position.coords.latitude;
        userLon = position.coords.longitude;
        
        // Get user's location name
        const locationName = await getLocationName(userLat, userLon);
        status.innerHTML = `üìç Location: <strong>${locationName}</strong> (${userLat.toFixed(4)}, ${userLon.toFixed(4)})`;
        
        // Get selected sports
        const selectedSports = Array.from(document.querySelectorAll('input[name="sport"]:checked'))
          .map(cb => cb.value);
        
        // Load all tournaments from unified database
        const allTournaments = loadAllTournaments();
        
        // Filter and sort tournaments
        let nearby = allTournaments
          .map(t => ({
            ...t,
            distance: getDistance(userLat, userLon, t.lat, t.lon)
          }))
          .filter(t => selectedSports.length === 0 || selectedSports.includes(t.sport))
          .filter(t => {
            // Check if tournament has valid date (show upcoming tournaments)
            if (!t.date && !t.startDate) return true;
            
            try {
              const dateStr = t.date || t.startDate;
              // Show tournaments from 2024 onwards
              if (dateStr.includes("2024") || dateStr.includes("2025") || 
                  dateStr.includes("2026") || dateStr.includes("2027") || 
                  dateStr.includes("2028")) {
                return true;
              }
            } catch (e) {
              return true;
            }
            return false;
          })
          .sort((a, b) => a.distance - b.distance);
        
        // Display results
        displayTournaments(nearby);
        
        // Initialize map
        initMap(userLat, userLon);
        
        // Add markers to map
        addTournamentMarkers(nearby);
        
        // Fit bounds to show all markers
        if (nearby.length > 0) {
          const markerGroup = L.featureGroup([userMarker, ...tournamentMarkers]);
          map.fitBounds(markerGroup.getBounds().pad(0.1));
        }
        
      } catch (error) {
        console.error('Error:', error);
        status.textContent = "Error loading tournaments. Please try again.";
        status.className = "error";
      }
    },
    
    (error) => {
      let message = "Location access denied or unavailable. ";
      switch(error.code) {
        case error.PERMISSION_DENIED:
          message += "Please enable location permissions in your browser settings.";
          break;
        case error.POSITION_UNAVAILABLE:
          message += "Location information is unavailable.";
          break;
        case error.TIMEOUT:
          message += "The request to get your location timed out.";
          break;
      }
      status.textContent = message;
      status.className = "error";
    },
    { timeout: 10000, enableHighAccuracy: true }
  );
}

// Get location name from coordinates
async function getLocationName(lat, lon) {
  try {
    const response = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10`,
      {
        headers: {
          'User-Agent': 'TournamentFinderApp/1.0'
        }
      }
    );
    
    if (response.ok) {
      const data = await response.json();
      return data.display_name.split(',')[0] || 'Your Location';
    }
  } catch (error) {
    console.error('Error getting location name:', error);
  }
  return 'Your Location';
}

// Display tournaments
function displayTournaments(tournaments) {
  const resultsContainer = document.getElementById('results');
  
  if (tournaments.length === 0) {
    resultsContainer.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üèÜ</div>
        <h3>No Tournaments Found</h3>
        <p>No upcoming tournaments found matching your selected sports. Try selecting different sports or check back later for new tournaments in your area.</p>
        <button class="main-btn" onclick="findTournaments()" style="max-width: 300px;">
          üîç Search Again
        </button>
      </div>
    `;
    return;
  }
  
  let html = `
    <div class="results-header">
      <h2>üéØ Found ${tournaments.length} Upcoming Tournaments</h2>
      <p class="results-count">Showing tournaments sorted by distance from your location</p>
    </div>
  `;
  
  tournaments.forEach((tournament) => {
    // Check if tournament is organizer-created (not system)
    const isOrganizer = tournament.organizerId !== 'system' && tournament.organizerId !== undefined;
    const cardClass = isOrganizer ? 'tournament-card organizer-tournament' : 'tournament-card';
    
    html += `
      <div class="${cardClass}">
        <div class="tournament-header">
          <div>
            <h3 class="tournament-title">${tournament.name}</h3>
            <div class="tournament-meta">
              <span class="distance">${tournament.distance} km away</span>
              <span class="sport-badge">${tournament.sport}</span>
              ${isOrganizer ? '<span class="organizer-badge">Organizer Event</span>' : ''}
            </div>
          </div>
        </div>
        
        <div class="tournament-details">
          <div class="detail-row">
            <span class="detail-icon">üìç</span>
            <span><strong>Location:</strong> ${tournament.location}</span>
          </div>
          <div class="detail-row">
            <span class="detail-icon">üìÖ</span>
            <span><strong>Date:</strong> ${tournament.date || formatDate(tournament.startDate)}</span>
          </div>
          <div class="detail-row">
            <span class="detail-icon">üí∞</span>
            <span><strong>Entry Fee:</strong> ${tournament.fee || 'TBD'}</span>
          </div>
          ${tournament.prizeMoney ? `
            <div class="detail-row">
              <span class="detail-icon">üèÜ</span>
              <span><strong>Prize Money:</strong> ${tournament.prizeMoney}</span>
            </div>
          ` : ''}
          ${tournament.details ? `
            <div class="detail-row">
              <span class="detail-icon">üìù</span>
              <span>${tournament.details}</span>
            </div>
          ` : ''}
        </div>
        
        ${isOrganizer ? `
          <div class="organizer-info">
            <div class="organizer-label">Organized by:</div>
            <div>${tournament.organizerName || 'Local Organizer'}</div>
          </div>
        ` : ''}
        
        <div class="card-actions">
          ${tournament.regLink ? `
            <a href="${tournament.regLink}" target="_blank" class="register-btn">
              Register Now
            </a>
          ` : ''}
          <button class="route-btn" onclick="showRouteToTournament(${JSON.stringify(tournament).replace(/"/g, '&quot;')})">
            Get Directions
          </button>
        </div>
      </div>
    `;
  });
  
  resultsContainer.innerHTML = html;
}

function formatDate(dateString) {
  if (!dateString) return 'Date not specified';
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-IN', {
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    });
  } catch (e) {
    return dateString;
  }
}

// Add tournament markers to map
function addTournamentMarkers(tournaments) {
  // Clear previous markers
  tournamentMarkers.forEach(marker => {
    if (map && marker) map.removeLayer(marker);
  });
  tournamentMarkers = [];
  
  // Add new markers
  tournaments.forEach((tournament) => {
    const isOrganizer = tournament.organizerId !== 'system' && tournament.organizerId !== undefined;
    const iconColor = isOrganizer ? '#7c3aed' : '#10b981';
    const sportLetter = tournament.sport.charAt(0);
    
    const marker = L.marker([tournament.lat, tournament.lon], {
      icon: L.divIcon({
        className: 'tournament-marker',
        html: `
          <div style="
            background: ${iconColor};
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
          ">${sportLetter}</div>
        `,
        iconSize: [44, 44],
        iconAnchor: [22, 22]
      })
    }).addTo(map)
      .bindPopup(`
        <div style="padding: 10px; max-width: 250px;">
          <h4 style="margin: 0 0 8px 0; color: ${isOrganizer ? '#7c3aed' : '#1e40af'};">${tournament.name}</h4>
          <p style="margin: 0 0 5px 0; font-size: 12px; color: #666;">
            <strong>${tournament.sport}</strong> ‚Ä¢ ${tournament.distance} km away
          </p>
          <p style="margin: 0 0 5px 0; font-size: 12px;">üìç ${tournament.location}</p>
          <p style="margin: 0 0 10px 0; font-size: 12px;">üìÖ ${tournament.date || formatDate(tournament.startDate)}</p>
          <div style="display: flex; gap: 5px;">
            <button onclick="showRouteToTournament(${JSON.stringify(tournament).replace(/"/g, '&quot;')})" 
                    style="background: #3b82f6; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;">
              Get Directions
            </button>
            ${tournament.regLink ? `
              <a href="${tournament.regLink}" target="_blank" style="background: #10b981; color: white; text-decoration: none; padding: 5px 10px; border-radius: 4px; font-size: 11px;">
                Register
              </a>
            ` : ''}
          </div>
        </div>
      `);
    
    tournamentMarkers.push(marker);
  });
}

// Show route to tournament
function showRouteToTournament(tournament) {
  if (!userLat || !userLon) {
    alert("Please find tournaments first to get your location.");
    return;
  }
  
  // Remove previous routing control
  if (routingControl) {
    map.removeControl(routingControl);
  }
  
  // Show directions panel
  document.getElementById('directionsPanel').classList.add('active');
  
  // Update panel content
  document.getElementById('routeSummary').innerHTML = `
    <h3 style="margin-top: 0; color: #1e40af;">Route to ${tournament.name}</h3>
    <div class="summary-item">
      <span>üìç From:</span>
      <span>Your Location</span>
    </div>
    <div class="summary-item">
      <span>üéØ To:</span>
      <span>${tournament.location}</span>
    </div>
    <div class="summary-item">
      <span>üìè Distance:</span>
      <span><strong>${tournament.distance} km</strong></span>
    </div>
    <div class="summary-item">
      <span>üèÜ Sport:</span>
      <span>${tournament.sport}</span>
    </div>
    <div class="summary-item">
      <span>üìÖ Date:</span>
      <span>${tournament.date || formatDate(tournament.startDate)}</span>
    </div>
  `;
  
  // Initialize routing control
  routingControl = L.Routing.control({
    waypoints: [
      L.latLng(userLat, userLon),
      L.latLng(tournament.lat, tournament.lon)
    ],
    routeWhileDragging: false,
    showAlternatives: false,
    lineOptions: {
      styles: [
        { color: '#3b82f6', opacity: 0.8, weight: 6 }
      ]
    },
    createMarker: function(i, waypoint) {
      if (i === 0) {
        return L.marker(waypoint.latLng, {
          icon: L.divIcon({
            className: 'start-marker',
            html: '<div style="background:#3b82f6; width:24px; height:24px; border-radius:50%; border:4px solid white; box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
          })
        }).bindPopup('Your Location');
      } else {
        return L.marker(waypoint.latLng, {
          icon: L.divIcon({
            className: 'destination-marker',
            html: '<div style="background:#ef4444; width:24px; height:24px; border-radius:50%; border:4px solid white; box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
          })
        }).bindPopup(tournament.name);
      }
    },
    router: L.Routing.osrmv1({
      serviceUrl: 'https://router.project-osrm.org/route/v1',
      profile: 'driving'
    })
  }).addTo(map);
  
  // Listen for route found event
  routingControl.on('routesfound', function(e) {
    const routes = e.routes;
    const summary = routes[0].summary;
    
    // Update route summary
    const summaryDiv = document.getElementById('routeSummary');
    summaryDiv.innerHTML += `
      <div class="summary-item">
        <span>üìè Route Distance:</span>
        <span><strong>${(summary.totalDistance / 1000).toFixed(1)} km</strong></span>
      </div>
      <div class="summary-item">
        <span>‚è±Ô∏è Estimated Time:</span>
        <span><strong>${Math.round(summary.totalTime / 60)} minutes</strong></span>
      </div>
    `;
    
    // Display route instructions
    const instructionsDiv = document.getElementById('routeInstructions');
    instructionsDiv.innerHTML = '<h3 style="margin-top: 0;">Turn-by-Turn Directions:</h3>';
    
    routes[0].instructions.forEach((instruction, index) => {
      const distanceKm = (instruction.distance / 1000).toFixed(1);
      instructionsDiv.innerHTML += `
        <div class="instruction-step">
          <div class="step-number">${index + 1}</div>
          <div class="step-text">
            <div>${instruction.text}</div>
            <div class="step-distance">${distanceKm} km</div>
          </div>
        </div>
      `;
    });
    
    // Fit map to show the route
    if (routes[0].coordinates && routes[0].coordinates.length > 0) {
      const bounds = L.latLngBounds(routes[0].coordinates);
      map.fitBounds(bounds.pad(0.1));
    }
  });
  
  // Center map on route
  map.setView([(userLat + tournament.lat) / 2, (userLon + tournament.lon) / 2], 11);
}

// Hide directions panel
function hideDirections() {
  document.getElementById('directionsPanel').classList.remove('active');
  
  // Remove routing control
  if (routingControl) {
    map.removeControl(routingControl);
    routingControl = null;
  }
}

// Show organizer benefits
function showOrganizerBenefits() {
  alert(`üéØ Organizer Benefits:

  1. Create unlimited tournaments
  2. Reach thousands of potential participants
  3. Set custom registration fees
  4. Manage registrations easily
  5. Get tournament analytics
  6. Promote your events locally

  Click "Switch to Organizer Dashboard" to get started!`);
}

function logout() {
  localStorage.removeItem('currentUser');
  window.location.href = "index.html";
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  // Setup user interface based on user type
  setupUserInterface();
  
  // Initialize database
  initializeDatabase();
  
  // Add keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // Escape key to close directions panel
    if (e.key === 'Escape') {
      hideDirections();
    }
    
    // Ctrl+F to focus search
    if (e.ctrlKey && e.key === 'f') {
      e.preventDefault();
      const firstCheckbox = document.querySelector('input[name="sport"]');
      if (firstCheckbox) firstCheckbox.focus();
    }
  });
});
</script>
</body>
</html>